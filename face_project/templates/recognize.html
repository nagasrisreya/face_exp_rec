<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Real-Time Face & Emotion Recognition</title>
  <style>
    :root{
      --accent:#19a6d6;
      --glass: rgba(255,255,255,0.07);
      --muted: rgba(255,255,255,0.85);
      --card-bg: linear-gradient(180deg, rgba(255,255,255,0.02), rgba(255,255,255,0.01));
    }
    html,body{height:100%;margin:0;}
    body {
      font-family: "Segoe UI", Arial, sans-serif;
      display: flex;
      flex-direction: column;
      align-items: center;
      background: linear-gradient(135deg,#66c3e6 0%, #8a6bd8 50%, #6dd5ed 100%);
      background-size: 800% 800%;
      animation: gradientBG 18s ease infinite;
      color: #fff;
      padding: 28px 16px;
    }
    @keyframes gradientBG {
      0%{background-position:0% 50%}
      50%{background-position:100% 50%}
      100%{background-position:0% 50%}
    }
    header {
      width:100%;
      display:flex;
      justify-content:center;
      align-items:center;
      margin-bottom: 18px;
    }
    h1 {
      margin: 0;
      font-size: 2.4rem;
      text-align:center;
      text-shadow: 0 6px 12px rgba(0,0,0,0.3);
      letter-spacing: 1px;
    }
    .main-content {
      display: flex;
      gap: 24px;
      align-items: flex-start;
      width: min(94vw, 1100px);
    }
    .left-panel {
      flex: 1 1 60%;
      min-width: 320px;
      display:flex;
      flex-direction:column;
      align-items:center;
      gap:12px;
    }
    .right-panel {
      flex: 0 0 360px;
      min-width: 260px;
      display:flex;
      flex-direction:column;
      gap:12px;
      align-items: stretch;
    }
    video{
      width: 80%;
      height: auto;
      max-height: 540px;
      border-radius: 14px;
      border: 4px solid rgba(255,255,255,0.95);
      box-shadow: 0 18px 40px rgba(0,0,0,0.35);
      background: #000;
    }
    .controls {
      display:flex;
      gap: 12px;
      flex-wrap:wrap;
      justify-content:center;
      align-items:center;
      margin-top: 6px;
    }
    .btn {
      display:inline-flex;
      align-items:center;
      gap:8px;
      padding:10px 18px;
      border-radius:10px;
      border: none;
      cursor: pointer;
      font-weight:700;
      font-size:15px;
      transition: transform .12s ease, box-shadow .12s ease;
      color:#fff;
    }
    .btn:hover{ transform: translateY(-3px); box-shadow:0 8px 20px rgba(0,0,0,0.25); }
    .btn.start { background: linear-gradient(180deg,#2fb24b,#1c8b32); }
    .btn.stop  { background: linear-gradient(180deg,#ff6b6b,#d82a2a); }
    .btn.manual{ background: linear-gradient(180deg,#3690ff,#0a5fd6); }

    #response {
      margin-top:6px;
      min-height:24px;
      font-size: 18px;
      color: var(--muted);
      text-shadow: 0 3px 8px rgba(0,0,0,0.25);
    }
    .indicator {
      margin-top:6px;
      padding:6px 12px;
      border-radius: 14px;
      background: rgba(255,255,255,0.08);
      font-weight:700;
      color:#fff;
      text-align:center;
    }
    .indicator.on {
      background: linear-gradient(90deg, rgba(124,252,0,0.18), rgba(124,252,0,0.08));
      box-shadow: 0 6px 18px rgba(124,252,0,0.08);
    }
    .indicator.off {
      background: rgba(255,255,255,0.06);
      opacity: 0.95;
      box-shadow: none;
    }
    .table-wrap {
      border-radius: 12px;
      overflow: hidden;
      box-shadow: 0 12px 30px rgba(0,0,0,0.25);
      background: var(--card-bg);
      backdrop-filter: blur(4px);
      border: 1px solid rgba(255,255,255,0.03);
      padding: 4px;
      font-size: 13px;
    }
    table {
      width: 100%;
      border-collapse: collapse;
      color: #fff;
      table-layout: fixed;
    }
    thead th {
      text-align: left;
      font-size: 13px;
      padding: 8px 8px;
      background: rgba(0,0,0,0.12);
      font-weight: 700;
    }
    tbody td {
      padding: 6px 8px;
      font-size: 13px;
      border-top: 1px solid rgba(255,255,255,0.03);
      word-wrap: break-word;
    }
    tbody tr:nth-child(even) {
      background: linear-gradient(90deg, rgba(255,255,255,0.01), rgba(255,255,255,0.00));
    }
    .bottom {
      margin-top:14px;
    }
    a.home {
      display:inline-block;
      padding:8px 16px;
      background: rgba(0,0,0,0.12);
      color:#fff;
      border-radius:10px;
      text-decoration:none;
      font-weight:700;
    }
    #confidenceScore {
      margin-top: 12px;
      font-size: 1.1rem;
      font-weight: 600;
      text-align: center;
      color: #00ffd5;
    }
    @media (max-width: 900px) {
      .main-content { flex-direction: column; align-items: center; }
      .right-panel { width: 100%; flex: none; }
      .left-panel { width: 100%; }
      video { max-height: 420px; }
    }
    @media (max-width: 480px) {
      h1 { font-size: 1.4rem; }
      .btn { font-size: 13px; padding: 8px 10px; }
      thead th, tbody td { font-size: 13px; padding: 8px; }
    }
  </style>
</head>
<body>
  <header><h1>üîç Real-Time Face & Emotion Recognition</h1></header>

  <div class="main-content" role="main">
    <section class="left-panel" aria-label="camera">
      <video id="video" autoplay muted playsinline></video>

      <div class="controls" role="group" aria-label="controls">
        <button class="btn start" id="startBtn">‚ñ∂ Start Counting</button>
        <button class="btn stop" id="stopBtn">‚èπ Stop Counting</button>
        <button class="btn manual" id="manualBtn">üì∏ Manual Recognize</button>
      </div>

      <div id="response">Recognition result will appear here...</div>
      <div id="countingIndicator" class="indicator off">Counting: <strong id="countText">OFF</strong></div>
    </section>

    <aside class="right-panel" aria-label="emotion counts">
      <div class="table-wrap" aria-live="polite">
        <table id="emotionTable" role="table">
          <thead>
            <tr>
              <th>Name</th>
              <th>Emotion</th>
              <th>Count</th>
              <th>First Detected</th>
              <th>Last Detected</th>
            </tr>
          </thead>
          <tbody id="emotionBody">
            <tr><td colspan="5" style="color:rgba(255,255,255,0.75);padding:14px 16px">No data yet...</td></tr>
          </tbody>
        </table>
      </div>

      <!-- üß† Confidence Score -->
      <div id="confidenceScore">Confidence: 0</div>

      <!-- üóë Delete All button -->
      <button class="btn stop" id="deleteBtn">üóë Delete All</button>
    </aside>
  </div>

  <div class="bottom"><a href="/" class="home">‚¨Ö Back to Home</a></div>

  <script>
    function getCookie(name) {
      let v=null;
      if (document.cookie && document.cookie!==''){
        const c=document.cookie.split(';');
        for (let i=0;i<c.length;i++){
          const t=c[i].trim();
          if (t.substring(0,name.length+1)===(name+'=')){
            v=decodeURIComponent(t.substring(name.length+1));break;
          }
        }
      }
      return v;
    }

    const csrftoken=getCookie('csrftoken');
    const video=document.getElementById('video'),
          responseEl=document.getElementById('response'),
          startBtn=document.getElementById('startBtn'),
          stopBtn=document.getElementById('stopBtn'),
          manualBtn=document.getElementById('manualBtn'),
          countIndicator=document.getElementById('countingIndicator'),
          countText=document.getElementById('countText'),
          emotionBody=document.getElementById('emotionBody'),
          deleteBtn=document.getElementById('deleteBtn'),
          confidenceEl=document.getElementById('confidenceScore');

    let isProcessing=false, autoInterval=null;

    navigator.mediaDevices.getUserMedia({video:true})
      .then(s=>video.srcObject=s)
      .catch(e=>{console.error('Camera error:',e);responseEl.textContent='Camera error: '+(e.message||e);});

    function captureAndSend(){
      if(isProcessing||video.videoWidth===0)return;
      isProcessing=true;
      const c=document.createElement('canvas');
      c.width=320;c.height=240;
      const x=c.getContext('2d');
      x.drawImage(video,0,0,c.width,c.height);
      const img=c.toDataURL('image/jpeg',0.6);
      fetch('/recognize_user/',{
        method:'POST',credentials:'same-origin',
        headers:{'X-CSRFToken':csrftoken,'Content-Type':'application/x-www-form-urlencoded'},
        body:`image=${encodeURIComponent(img)}`
      }).then(r=>r.json()).then(d=>{
        responseEl.textContent=d.message||'No face recognized.';
        isProcessing=false;fetchEmotionStats();
      }).catch(e=>{
        console.error('Recognition error:',e);
        responseEl.textContent='‚ö† Error recognizing face.';
        isProcessing=false;
      });
    }

    function startAutoRecognition(){if(autoInterval)return;autoInterval=setInterval(captureAndSend,2000);}
    function stopAutoRecognition(){if(!autoInterval)return;clearInterval(autoInterval);autoInterval=null;}
    startAutoRecognition();

    function startCounting(){
      fetch('/start-counting/',{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':csrftoken}})
      .then(r=>r.json()).then(d=>{
        const on=!!d.counting;
        countText.textContent=on?'ON':'OFF';
        countIndicator.classList.toggle('on',on);
        countIndicator.classList.toggle('off',!on);
        confidenceEl.textContent='Confidence: 0';
        fetchEmotionStats();
      });
    }

    function stopCounting(){
      fetch('/stop-counting/',{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':csrftoken}})
      .then(r=>r.json())
      .then(d=>{
        const on=!!d.counting;
        countText.textContent=on?'ON':'OFF';
        countIndicator.classList.toggle('on',on);
        countIndicator.classList.toggle('off',!on);
        if(d.final_confidence!==undefined){
          confidenceEl.textContent='Final Confidence: '+d.final_confidence;
        }
        fetchEmotionStats();
      });
    }

    function fetchCountingStatus(){
      fetch('/counting-status/',{credentials:'same-origin'})
      .then(r=>r.json()).then(d=>{
        const on=!!d.counting;
        countText.textContent=on?'ON':'OFF';
        countIndicator.classList.toggle('on',on);
        countIndicator.classList.toggle('off',!on);
      });
    }

    function fetchEmotionStats(){
      fetch('/emotion-stats/',{credentials:'same-origin'})
      .then(r=>r.json()).then(rows=>{
        if(!Array.isArray(rows)||rows.length===0){
          emotionBody.innerHTML='<tr><td colspan="5" style="color:rgba(255,255,255,0.75);padding:14px 16px">No data yet...</td></tr>';
        } else {
          emotionBody.innerHTML=rows.map(row=>{
            const f=row.first_detected?new Date(row.first_detected).toLocaleString():'-';
            const l=row.last_detected?new Date(row.last_detected).toLocaleString():'-';
            return `<tr><td>${escapeHtml(row.name)}</td><td>${escapeHtml(row.emotion)}</td><td>${row.count}</td><td>${f}</td><td>${l}</td></tr>`;
          }).join('');
        }
        updateConfidenceScore(); // üî• update confidence dynamically
      });
    }

    // === Calculate confidence dynamically from table ===
    function updateConfidenceScore() {
      const rows = Array.from(emotionBody.querySelectorAll('tr')).filter(r => r.children.length===5);
      if(rows.length === 0){ confidenceEl.textContent = 'Confidence: 0'; return; }

      let totalCount = 0, weightedSum = 0;
      rows.forEach(r=>{
        const count = parseInt(r.children[2].textContent) || 0;
        const emotion = r.children[1].textContent.toLowerCase();
        let weight = 1;
        switch(emotion){
          case 'happy': weight = 1; break;
          case 'neutral': weight = 0.8; break;
          case 'sad': weight = 0.5; break;
          case 'angry': weight = 0.3; break;
          default: weight = 0.6;
        }
        weightedSum += count * weight;
        totalCount += count;
      });
      const confidence = totalCount ? ((weightedSum / totalCount) * 100).toFixed(1) : 0;
      confidenceEl.textContent = 'Confidence: ' + confidence + '%';
    }

    function escapeHtml(s){if(s==null)return'';return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#039;');}

    function deleteAllEmotions(){
      if(!confirm('Are you sure you want to delete all emotion records?'))return;
      fetch('/delete-emotions/',{method:'POST',credentials:'same-origin',headers:{'X-CSRFToken':csrftoken}})
      .then(r=>r.json())
      .then(d=>{
        responseEl.textContent=d.message||'All emotion records deleted.';
        fetchEmotionStats();
      })
      .catch(e=>{
        console.error('Error deleting emotions:',e);
        responseEl.textContent='‚ö† Error deleting records.';
      });
    }

    startBtn.addEventListener('click',startCounting);
    stopBtn.addEventListener('click',stopCounting);
    manualBtn.addEventListener('click',captureAndSend);
    deleteBtn.addEventListener('click',deleteAllEmotions);

    fetchCountingStatus();
    fetchEmotionStats();
    setInterval(fetchCountingStatus,4000);
    setInterval(fetchEmotionStats,5000);
  </script>
</body>
</html>
